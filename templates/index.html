<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Luno Bot Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        :root { --accent: #2a5298; --success: #4CAF50; --danger: #f44336; --warn: #FFB74D; --muted: #666; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Roboto, Arial, sans-serif; margin: 0; padding: 16px; background: #f4f6fb; color: #222; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #fff; padding: 16px; border-radius: 8px; border: 1px solid #e6e9ef; }
        h1 { margin: 0; font-size: 20px; color: var(--accent); }
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #e6e9ef; }
        .tab-button { background: #fff; border: 1px solid #ddd; padding: 10px 14px; border-radius: 6px; cursor: pointer; color: var(--muted); font-size: 14px; font-weight: 500; transition: all 0.2s; }
        .tab-button:hover { background: #f9f9f9; border-color: var(--accent); color: var(--accent); }
        .tab-button.active { background: linear-gradient(180deg, #fff, #f0f6ff); color: var(--accent); border-color: var(--accent); font-weight: 600; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: #fff; padding: 16px; border-radius: 8px; border: 1px solid #e6e9ef; margin-bottom: 12px; }
        .card h2 { margin: 0 0 12px 0; color: var(--accent); font-size: 16px; }
        .card h3 { margin: 12px 0 8px 0; color: #333; font-size: 14px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin: 12px 0; }
        .metric { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .metric:last-child { border-bottom: none; }
        .metric-label { color: var(--muted); font-weight: 500; }
        .metric-value { color: var(--accent); font-weight: bold; font-size: 15px; }
        .btn-primary { background: var(--accent); color: #fff; padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        .btn-primary:hover { background: #1e3c72; }
        input, select, textarea { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1); }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 6px; color: var(--muted); font-size: 13px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; }
        #signal-log-terminal { background: #0b1220; color: #e6f2ff; padding: 12px; border-radius: 6px; height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.6; border: 1px solid #1a3344; margin-top: 12px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: #fff; border-radius: 10px; padding: 30px; max-width: 600px; width: 100%; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; }
        .modal-header h2 { margin: 0; color: var(--accent); font-size: 18px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .alert-box { padding: 12px 16px; border-radius: 6px; margin-bottom: 12px; display: none; font-size: 14px; font-weight: 500; }
        .alert-success { background: #c8e6c9; color: #2e7d32; display: block; border: 1px solid #81c784; }
        .alert-error { background: #ffcdd2; color: #c62828; display: block; border: 1px solid #ef5350; }
        .alert-info { background: #bbdefb; color: #1565c0; display: block; border: 1px solid #64b5f6; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 12px; }
        thead { background: #f5f5f5; border-bottom: 2px solid #ddd; }
        th { padding: 10px; text-align: left; color: var(--muted); font-weight: 600; font-size: 12px; }
        td { padding: 10px; border-bottom: 1px solid #f0f0f0; }
        tr:hover { background: #f9f9f9; }
        tr[onclick] { cursor: pointer; }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .status-badge.live { background: #c8e6c9; color: #1b5e20; }
        .status-badge.dry { background: #fff3e0; color: #e65100; }
        .action-buy { color: var(--success); font-weight: bold; }
        .action-sell { color: var(--danger); font-weight: bold; }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1> Luno Trading Bot Dashboard</h1>
        <div style="display:flex; gap:12px; align-items:center;">
            {% if user %}
            <div style="font-size:14px; color:#333; font-weight:600; margin-right:12px;">Welcome, {{ user.name }}</div>
            <div><a href="{{ url_for('logout') }}" style="color:#e74c3c; text-decoration:none; font-weight:600;">Logout</a></div>
            {% else %}
            <div><a href="{{ url_for('login') }}" style="color:var(--accent); text-decoration:none; font-weight:600; margin-right:8px;">Login</a></div>
            <div><a href="{{ url_for('signup') }}" style="color:var(--accent); text-decoration:none; font-weight:600;">Signup</a></div>
            {% endif %}
            <div style="color: var(--muted); font-size: 13px;">Local Environment</div>
            <div id="tv-status-badge" style="display:flex; gap:8px; align-items:center;">
                <span class="status-badge" id="tv-badge" style="background:#fff3e0; color:#e65100;">TV: Unknown</span>
                <span id="tv-last" style="color:var(--muted); font-size:12px;">Last: --</span>
            </div>
        </div>
    </header>
    
    <div class="tabs">
        <button class="tab-button active" onclick="switchTab('dashboard', this)"> Dashboard</button>
        <button class="tab-button" onclick="switchTab('monitoring', this)"> Monitoring</button>
        <button class="tab-button" onclick="switchTab('trends', this)"> Trends</button>
        <button class="tab-button" onclick="switchTab('compound', this)"> Compound</button>
        <button class="tab-button" onclick="switchTab('coins', this)"> Coins</button>
        <button class="tab-button" onclick="switchTab('signal_log', this)"> Signal Log</button>
        <button class="tab-button" onclick="switchTab('credentials', this)"> Credentials</button>
        <button class="tab-button" onclick="switchTab('settings', this)"> Settings</button>
        <button class="tab-button" onclick="switchTab('howto', this)"> How to use</button>
    </div>
    
    <div id="dashboard" class="tab-content active">
        <div class="grid-2">
            <div class="card">
                <h2> Live Price Chart</h2>
                <div style="display: flex; gap: 12px; margin-bottom: 12px; align-items: center; flex-wrap: wrap;">
                    <button id="realtimeToggle" class="btn-primary" style="background: #e74c3c;" onclick="toggleRealtimeChart()"> OFF</button>
                    <label style="color: var(--muted); font-size: 13px;">Interval:</label>
                    <input id="refreshInterval" type="range" min="500" max="5000" value="1000" step="100" style="width: 100px;">
                    <span id="intervalDisplay" style="color: var(--muted); font-weight: bold;">1000ms</span>
                </div>
                <div style="height: 250px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: center; color: #999; margin-bottom: 12px;">
                    <canvas id="priceChart" style="width: 100%; height: 100%;"></canvas>
                </div>
                <div class="metric">
                    <span class="metric-label">Current Price</span>
                    <span class="metric-value" id="current-price">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Pair</span>
                    <span class="metric-value" id="current-pair">--</span>
                </div>
            </div>
            
            <div class="card">
                <h2> Bot Status</h2>
                <div class="metric">
                    <span class="metric-label">Status</span>
                    <span class="metric-value" id="bot-status">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Coin</span>
                    <span class="metric-value" id="bot-coin">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Mode</span>
                    <span class="status-badge" id="mode-badge">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Last Update</span>
                    <span class="metric-value" style="font-size: 13px;" id="last-update">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Total Trades</span>
                    <span class="metric-value" id="total-trades">0</span>
                </div>
                <hr style="border: none; border-top: 1px solid #eee; margin: 12px 0;">
                <div class="metric">
                    <span class="metric-label">Buy Price</span>
                    <span class="metric-value" style="color: var(--success);" id="buy-price">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Current Bid</span>
                    <span class="metric-value" id="current-bid">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Current Value</span>
                    <span style="display:flex; gap:8px; align-items:center;"><span class="metric-value" id="current-value">--</span>
                        <button id="toggle-per-unit" class="btn-primary" style="padding:4px 8px; font-size:12px; background:#666;">Per 1</button>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Profit / %</span>
                    <span class="metric-value" id="profit-display">-- / --</span>
                </div>
            </div>
            <div style="margin-top:8px;">
                <div id="bot-coin-tabs" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
            </div>
            <div style="margin-top:8px;">
                <button id="make-active-coin" class="btn-primary" style="padding:6px 10px; font-size:13px;" onclick="makeActiveCoin()">Make Active</button>
                <span id="make-active-msg" style="margin-left:8px;color:var(--muted);font-size:13px;"></span>
            </div>
            
            <div class="card">
                <h2>💰 Account Balance</h2>
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <button class="btn-primary" onclick="fetchAccountBalance()">🔄 Refresh</button>
                </div>
                <div id="account-balance-container" style="margin-top: 12px;">
                    <div style="text-align: center; color: #999; padding: 20px;">Loading...</div>
                </div>
            </div>
        </div>
        
        <div class="grid-2">
            <div class="card">
                <h2> Auto-Sell Monitor</h2>
                <div style="background: #fffbea; padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid #FFB74D;">
                    <p style="margin: 0; font-size: 13px; color: #f57f17; font-weight: 500;">💡 Tip: Use pair format like SOLNGN (not just SOL). Choose your asset from the dropdown below.</p>
                </div>
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <button id="autosell-toggle" class="btn-primary" onclick="toggleAutoSell()"> Start</button>
                    <button id="autosell-hold-btn" class="btn-primary" style="background: #666;" onclick="toggleHold()"> Hold</button>
                    <span id="autosell-status" class="status-badge dry"> STOPPED</span>
                </div>
                <div class="form-group">
                    <label>Target Profit %:</label>
                    <input id="autosell-target" type="number" value="2.0" step="0.1" min="0.1">
                </div>
                <div class="form-group">
                    <label>Trading Pair:</label>
                    <select id="autosell-pair-input">
                        <option value="USDTNGN">USDTNGN (Tether - USDT)</option>
                        <option value="USDCNGN">USDCNGN (USD Coin - USDC)</option>
                        <option value="XBTNGN">XBTNGN (Bitcoin - XBT/BTC)</option>
                        <option value="ETHNGN">ETHNGN (Ethereum - ETH)</option>
                        <option value="SOLNGN">SOLNGN (Solana - SOL)</option>
                        <option value="ATOMNGN">ATOMNGN (Cosmos - ATOM)</option>
                        <option value="LITNGN">LITNGN (Litecoin - LTC)</option>
                        <option value="XRPNGN">XRPNGN (XRP - XRP)</option>
                    </select>
                </div>
                <div id="autosell-message" class="alert-box"></div>
                <div id="autosell-monitor" style="display: none; margin-top: 12px; padding: 12px; background: #f0f7ff; border-radius: 6px;">
                    <h3 style="margin-top: 0; margin-bottom: 8px;">Live Monitor</h3>
                    <div class="metric">
                        <span class="metric-label">Pair</span>
                        <span class="metric-value" id="autosell-pair">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Profit</span>
                        <span class="metric-value" id="autosell-profit">--</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2> Manual Trade</h2>
                <div class="form-group">
                    <label>Pair:</label>
                    <input id="manual-pair" type="text" value="XBTNGN" placeholder="XBTNGN">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div class="form-group">
                        <label>Side:</label>
                        <select id="manual-side">
                            <option value="BUY">BUY</option>
                            <option value="SELL">SELL</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount:</label>
                        <input id="manual-amount" type="number" placeholder="0.0" min="0" step="0.01">
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn-primary" onclick="placeManualTrade()"> Trade</button>
                    <button class="btn-primary" style="background: #666;" onclick="resetManualTrade()"> Reset</button>
                </div>
                <div id="trade-message" class="alert-box" style="margin-top: 12px;"></div>
                <div style="margin-top: 12px; padding: 12px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid #2a5298; font-size: 12px; color: #1565c0;">
                    <strong>ℹ Minimum Order Sizes:</strong><br/>
                    USDTNGN: 1.0 | USDCNGN: 1.0 | XBTNGN: 0.0001<br/>
                    ETHNGN: 0.001 | SOLNGN: 0.01 | ATOMNGN: 0.1<br/>
                    LITNGN: 0.001 | XRPNGN: 1.0<br/>
                    <em>Trades below these amounts will be rejected by Luno.</em>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2> Trading Summary</h2>
            <div class="grid-3">
                <div style="background: #e8f5e9; padding: 16px; border-radius: 6px; border-left: 4px solid #4CAF50;">
                    <div style="color: #666; font-size: 12px;">Total Profit (NGN)</div>
                    <div style="font-size: 20px; font-weight: bold; color: #1b5e20; margin-top: 8px;" id="summary-profit">--</div>
                </div>
                <div style="background: #e3f2fd; padding: 16px; border-radius: 6px; border-left: 4px solid #2a5298;">
                    <div style="color: #666; font-size: 12px;">Profit %</div>
                    <div style="font-size: 20px; font-weight: bold; color: #1565c0; margin-top: 8px;" id="summary-pct">--%</div>
                </div>
                <div style="background: #fff3e0; padding: 16px; border-radius: 6px; border-left: 4px solid #FF9800;">
                    <div style="color: #666; font-size: 12px;">Auto-Sell Target</div>
                    <div style="font-size: 20px; font-weight: bold; color: #e65100; margin-top: 8px;" id="summary-target">--%</div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="monitoring" class="tab-content">
        <div class="card">
            <h2> Active Positions</h2>
            <div id="active-positions" style="display: grid; gap: 12px; margin-top: 12px;">
                <div style="text-align: center; color: #999; padding: 20px;">No active positions</div>
            </div>
        </div>
        <div class="card">
            <h2> Recent Trades</h2>
            <table>
                <thead>
                    <tr>
                        <th>Date/Time</th>
                        <th>Action</th>
                        <th>Price</th>
                        <th>Volume</th>
                    </tr>
                </thead>
                <tbody id="trades-body">
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px; color: #999;">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div id="trends" class="tab-content">
        <div class="card">
            <h2> Trend Analysis</h2>
            <div id="trend-signals" style="padding: 20px; text-align: center; color: #999;">Loading...</div>
        </div>
    </div>
    
    <div id="compound" class="tab-content">
        <div class="card">
            <h2> Compound Mode</h2>
            <div class="grid-3">
                <div style="background: #e8f5e9; padding: 12px; border-radius: 6px;">
                    <div style="color: var(--muted); font-size: 12px;">Total</div>
                    <div style="color: var(--success); font-size: 16px; font-weight: bold;" id="compound-total">--</div>
                </div>
                <div style="background: #c8e6c9; padding: 12px; border-radius: 6px;">
                    <div style="color: var(--muted); font-size: 12px;">Reinvested</div>
                    <div style="color: #1b5e20; font-size: 16px; font-weight: bold;" id="compound-reinvest">--</div>
                </div>
                <div style="background: #e3f2fd; padding: 12px; border-radius: 6px;">
                    <div style="color: var(--muted); font-size: 12px;">Savings</div>
                    <div style="color: #1565c0; font-size: 16px; font-weight: bold;" id="compound-savings">--</div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="coins" class="tab-content">
        <div class="card">
            <h2> Supported Pairs</h2>
            <div class="grid-3" id="coins-grid">
                <div style="text-align: center; color: #999; padding: 20px;">Loading...</div>
            </div>
        </div>
    </div>
    
    <div id="credentials" class="tab-content">
        <div class="card" id="credential-form">
            <h2>🔐 Luno API Credentials</h2>
            <p style="color: var(--muted); font-size: 13px; margin-bottom: 16px;">Enter your Luno API credentials to enable live trading. Your credentials are stored securely in .env and never sent to external servers.</p>
            
            <div class="form-group">
                <label>API Key:</label>
                <input id="api-key" type="password" placeholder="Enter your Luno API Key" style="width: 100%;">
            </div>
            
            <div class="form-group">
                <label>API Secret:</label>
                <input id="api-secret" type="password" placeholder="Enter your Luno API Secret" style="width: 100%;">
            </div>
            
            <div class="form-group">
                <label>Trading Pair:</label>
                <select id="trading-pair" style="width: 100%;">
                    <option value="XBTNGN">XBTNGN (Bitcoin)</option>
                    <option value="ETHNGN">ETHNGN (Ethereum)</option>
                    <option value="USDTNGN">USDTNGN (Tether)</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                <button class="btn-primary" onclick="validateCredentials()">✓ Validate</button>
                <button class="btn-primary" style="background: #27ae60;" onclick="saveCredentials()">💾 Save</button>
                <button class="btn-primary" style="background: #e74c3c;" onclick="toggleCredentialVisibility()">👁 Show/Hide</button>
            </div>
            
            <div id="credential-message" class="alert-box" style="margin-top: 12px;"></div>
            
            <div class="card" style="background: #f9f9f9; margin-top: 20px; padding: 12px;">
                <h3>How to get your API credentials:</h3>
                <ol style="font-size: 13px; line-height: 1.8; color: var(--muted);">
                    <li>Log in to your <strong>Luno account</strong></li>
                    <li>Go to <strong>Settings → API Keys</strong></li>
                    <li>Click <strong>Create New Key</strong></li>
                    <li>Select <strong>Allow Trading</strong> permission</li>
                    <li>Copy the <strong>API Key</strong> and <strong>Secret Key</strong></li>
                    <li>Paste them above and click <strong>Validate</strong></li>
                </ol>
            </div>
            
            <div class="card" style="background: #fffbea; margin-top: 12px; padding: 12px; border: 1px solid #ffe082;">
                <h3 style="color: #f57f17; margin-top: 0;">⚠ Security Notice:</h3>
                <p style="font-size: 13px; color: #666; margin: 0;">
                    • Never share your API Secret key<br>
                    • Store credentials only locally in .env<br>
                    • Use a dedicated API key with minimal permissions<br>
                    • Enable IP whitelist on Luno for added security
                </p>
            </div>
        </div>
    </div>
    
    <div id="signal_log" class="tab-content">
        <div class="card">
            <h2> Signal Log</h2>
            <div style="display: flex; gap: 8px; margin-bottom: 12px; align-items: center;">
                <input id="log-refresh-interval" type="number" value="2000" min="500" step="500" style="width: 100px;">
                <label style="color: var(--muted); font-size: 13px;">ms</label>
                <button class="btn-primary" style="padding: 6px 10px; font-size: 12px;" onclick="refreshSignalLog()"></button>
            </div>
            <div id="signal-log-terminal">Initializing...</div>
        </div>
    </div>
    
    <div id="settings" class="tab-content">
        <div class="card">
            <h2> Strategy Configuration</h2>
            <div class="form-group">
                <label>Quote Priority (comma-separated, highest preference first)</label>
                <input id="quote-priority" type="text" value="USDT,USDC,NGN" placeholder="USDT,USDC,NGN">
                <div style="margin-top:8px;">
                    <button class="btn-primary" onclick="saveQuotePriority()">Save Quote Priority</button>
                    <span id="quote-save-msg" style="margin-left:8px;color:var(--muted);font-size:13px;"></span>
                </div>
            </div>
            <div class="form-group">
                <label>Coin:</label>
                <select id="coin-select">
                    <option>USDTNGN</option>
                    <option>XBTNGN</option>
                    <option>ETHNGN</option>
                </select>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                <div class="form-group">
                    <label>Buy Drop %</label>
                    <input id="buy-drop-pct" type="number" value="3.0" step="0.1">
                </div>
                <div class="form-group">
                    <label>Sell Profit %</label>
                    <input id="sell-profit-pct" type="number" value="10.0" step="0.1">
                </div>
                <div class="form-group">
                    <label>Stop Loss %</label>
                    <input id="stop-loss-pct" type="number" value="5.0" step="0.1">
                </div>
            </div>
            <button class="btn-primary" onclick="saveStrategyConfig()"> Save</button>
            <div id="strategy-message" class="alert-box" style="margin-top: 12px;"></div>
        </div>
    </div>

    <div id="howto" class="tab-content">
        <div class="card">
            <h2> How to use the Luno Trading Bot</h2>
            <div style="font-size:14px; line-height:1.6; color:#444;">
                <ol>
                    <li><strong>Login / Signup</strong> — Click <em>Login</em> at the top and sign in. Create an account if you don't have one.</li>
                    <li><strong>Add Luno API credentials</strong> — Go to <em>Credentials</em> and add your Luno API Key &amp; Secret (Allow trading). Click <em>Validate</em> then <em>Save</em>.</li>
                    <li><strong>Select a coin</strong> — Under <em>Bot Status</em> use the coin tabs to pick the coin you want to view. Click <em>Make Active</em> to set it as the strategy's active coin.</li>
                    <li><strong>Start Auto-Sell Monitor</strong> — In <em>Auto-Sell Monitor</em> choose a Target Profit % and Pair, then click <em>Start</em>. The monitor will watch the active coin and place sell orders when the target is reached.</li>
                    <li><strong>Hold a coin</strong> — Click <em>Hold</em> to prevent the monitor from selling the selected pair. Use <em>Unhold</em> to resume selling.</li>
                    <li><strong>Manual trades</strong> — Use <em>Manual Trade</em> to place a buy or sell. Observe the Minimum Order Sizes listed — trades smaller than these will be rejected.</li>
                    <li><strong>Monitor logs</strong> — Open <em>Signal Log</em> to see live bot logs. Use <em>Refresh</em> or the auto-refresh interval to keep it current.</li>
                    <li><strong>Safety</strong> — Use a dedicated Luno API key with trading permission only. When testing, set <code>DRY_RUN=true</code> in <code>.env</code> so no real orders are placed.</li>
                    <li><strong>Troubleshooting</strong> — If Start fails, check the alert message shown near the autosell card. Common issues: not logged in, missing API keys, or insufficient balance/minimum order size.</li>
                </ol>
                <p style="margin-top:12px;">If you'd like, I can turn this into a downloadable quick-start PDF or expand it with screenshots showing each step.</p>
            </div>
        </div>
    </div>
</div>

<div id="trade-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">Trade</h2>
            <button class="modal-close" onclick="closeTradeModal()">&times;</button>
        </div>
        <div id="modal-body"></div>
    </div>
</div>

<script>
    let priceChart = null;
    let realtimeStreamActive = false;
    let realtimeStreamInterval = null;
    let signalLogIntervalId = null;

    function switchTab(tabName, buttonEl) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        const tabEl = document.getElementById(tabName);
        if (!tabEl) return;
        tabEl.classList.add('active');
        if (buttonEl) buttonEl.classList.add('active');
        if (tabName === 'monitoring') loadMonitoringTrades();
        if (tabName === 'trends') refreshTrendSignals();
        if (tabName === 'compound') loadCompoundStats();
        if (tabName === 'coins') loadCoinsData();
        if (tabName === 'signal_log') { refreshSignalLog(); updateLogInterval(); }
        if (tabName === 'settings') loadStrategyConfig();
    }

    function updateDashboard() {
        fetch('/api/status').then(r => r.json()).then(data => {
            document.getElementById('current-price').textContent = '' + (data.last_price || 0).toFixed(2);
            document.getElementById('current-pair').textContent = data.pair || '--';
            document.getElementById('bot-status').textContent = (data.status || 'unknown').toUpperCase();
            // Show which coin the status refers to
            document.getElementById('bot-coin').textContent = (data.active_coin || data.pair || '--');
            const badge = document.getElementById('mode-badge');
            badge.className = 'status-badge ' + (data.dry_run ? 'dry' : 'live');
            badge.textContent = data.dry_run ? ' DRY' : ' LIVE';
            document.getElementById('last-update').textContent = data.last_update ? new Date(data.last_update).toLocaleTimeString() : '--';
            document.getElementById('total-trades').textContent = data.total_trades || 0;
            document.getElementById('buy-price').textContent = data.buy_price ? '' + data.buy_price.toFixed(2) : '--';
            document.getElementById('current-bid').textContent = data.bid ? '' + data.bid.toFixed(2) : '--';
            document.getElementById('current-value').textContent = data.current_value_ngn ? '' + data.current_value_ngn.toFixed(2) : '--';
            const pnl = data.profit_ngn || 0;
            const pct = data.profit_pct || 0;
            const profitEl = document.getElementById('profit-display');
            profitEl.textContent = '' + pnl.toFixed(2) + ' / ' + pct.toFixed(2) + '%';
            profitEl.style.color = pnl >= 0 ? '#4CAF50' : '#f44336';
            document.getElementById('summary-profit').textContent = '' + pnl.toFixed(2);
            document.getElementById('summary-pct').textContent = pct.toFixed(2) + '%';
            document.getElementById('summary-target').textContent = (document.getElementById('autosell-target').value || 2) + '%';
        }).catch(e => console.error('Status:', e));
        // Ensure coin tabs and view are initialized
        if (!window.botCoinsInitialized) loadBotCoinTabs();


    function loadBotCoinTabs() {
        // Populate tabs from /api/strategy supported_coins
        fetch('/api/strategy').then(r => r.json()).then(res => {
            if (!res) return;
            const coins = res.supported_coins || [];
            const container = document.getElementById('bot-coin-tabs');
            container.innerHTML = '';
            // store buttons to update bids later
            window._botTabButtons = {};
            coins.forEach(c => {
                const btn = document.createElement('button');
                btn.className = 'tab-button';
                btn.style.padding = '6px 10px';
                btn.dataset.coin = c;
                btn.textContent = c + ' (... )';
                btn.onclick = () => { selectBotCoin(c); };
                container.appendChild(btn);
                window._botTabButtons[c] = btn;
            });
            // initial bid load
            updateBotCoinBids();
            // refresh bids every 10s
            if (window.botCoinBidInterval) clearInterval(window.botCoinBidInterval);
            window.botCoinBidInterval = setInterval(updateBotCoinBids, 10000);
            // Select active coin
            const active = res.active_coin || coins[0];
            if (active) selectBotCoin(active);
            window.botCoinsInitialized = true;
        }).catch(e => { /* ignore */ });
    }

    function updateBotCoinBids() {
        try {
            const map = window._botTabButtons || {};
            Object.keys(map).forEach(c => {
                fetch('/api/ticker?pair=' + encodeURIComponent(c)).then(r => r.json()).then(t => {
                    if (t && t.success) {
                        const bid = parseFloat(t.bid || t.last || t.price || 0) || 0;
                        const btn = map[c];
                        if (btn) btn.textContent = c + (bid ? ' (' + bid.toFixed(2) + ')' : ' (--)');
                    }
                }).catch(e => {
                    const btn = map[c]; if (btn) btn.textContent = c + ' (err)';
                });
            });
        } catch (e) {}
    }

    let currentBotCoin = null;
    let showPerUnit = false;
    function selectBotCoin(pair) {
        currentBotCoin = (pair || '').toUpperCase();
        // update active button styles
        document.querySelectorAll('#bot-coin-tabs .tab-button').forEach(b => {
            if (b.textContent === currentBotCoin) b.classList.add('active'); else b.classList.remove('active');
        });
        // update coin label
        document.getElementById('bot-coin').textContent = currentBotCoin;
        // fetch ticker for this pair and update the card fields
        fetch('/api/ticker?pair=' + encodeURIComponent(currentBotCoin)).then(r => r.json()).then(t => {
            if (t && t.success) {
                const bid = parseFloat(t.bid || t.last || t.price || 0) || 0;
                document.getElementById('current-bid').textContent = bid ? '' + bid.toFixed(2) : '--';
                // If user wants per-unit display, show bid as Current Value
                refreshCurrentValueDisplay(bid);
            }
        }).catch(e => {});

        // If this is the active trading coin, use /api/status fields for buy/values; otherwise show N/A
        fetch('/api/status').then(r => r.json()).then(s => {
            const active = (s.active_coin || s.pair || '').toUpperCase();
            if (active === currentBotCoin) {
                document.getElementById('buy-price').textContent = s.buy_price ? '' + parseFloat(s.buy_price).toFixed(2) : '--';
                const pnl = s.profit_ngn || 0;
                const pct = s.profit_pct || 0;
                const profitEl = document.getElementById('profit-display');
                profitEl.textContent = '' + parseFloat(pnl).toFixed(2) + ' / ' + parseFloat(pct).toFixed(2) + '%';
                profitEl.style.color = (pnl >= 0) ? '#4CAF50' : '#f44336';
                // Show either per-unit or total holdings value depending on toggle
                if (!showPerUnit) {
                    document.getElementById('current-value').textContent = s.current_value_ngn ? '' + parseFloat(s.current_value_ngn).toFixed(2) : '--';
                }
            } else {
                document.getElementById('buy-price').textContent = '--';
                document.getElementById('profit-display').textContent = '-- / --';
                document.getElementById('current-value').textContent = '--';
            }
        }).catch(e => {});
    }

    function refreshCurrentValueDisplay(bidPrice) {
        try {
            const el = document.getElementById('current-value');
            if (showPerUnit) {
                const bid = parseFloat(bidPrice || 0) || 0;
                el.textContent = bid ? '' + bid.toFixed(2) : '--';
            } else {
                // fallback to API status value
                fetch('/api/status').then(r => r.json()).then(s => {
                    el.textContent = s.current_value_ngn ? '' + parseFloat(s.current_value_ngn).toFixed(2) : '--';
                }).catch(e => { el.textContent = '--'; });
            }
        } catch (e) {}
    }

    document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('toggle-per-unit');
        if (btn) btn.addEventListener('click', () => {
            showPerUnit = !showPerUnit;
            btn.textContent = showPerUnit ? 'Hold value' : 'Per 1';
            // Update display according to current bid
            const bidTxt = document.getElementById('current-bid').textContent || '';
            const bid = parseFloat(bidTxt.replace(/,/g, '')) || 0;
            refreshCurrentValueDisplay(bid);
        });
    });

    function makeActiveCoin() {
        if (!currentBotCoin) { showMessage('autosell-message', 'No coin selected', 'error'); return; }
        // 1) Set active coin on strategy
        fetch('/api/strategy/coin', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ coin: currentBotCoin }) })
            .then(r => r.json()).then(res => {
                if (res && res.success) {
                    document.getElementById('make-active-msg').textContent = 'Active: ' + currentBotCoin;
                    // 2) Restart auto-sell monitor to follow the new active coin: stop then start
                    const target = parseFloat(document.getElementById('autosell-target').value || 2.0);
                    // Attempt to stop (ignore failures) then start with the selected pair
                    fetch('/api/autosell/stop', { method: 'POST' }).finally(() => {
                        fetch('/api/autosell/start', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ pair: currentBotCoin, target_pct: target }) })
                            .then(async r2 => {
                                let res2 = null;
                                try { res2 = await r2.json(); } catch (e) {}
                                if (!r2.ok) {
                                    const msg = (res2 && (res2.error || res2.message)) || (r2.status + ' ' + r2.statusText);
                                    showMessage('autosell-message', 'Active set but autosell start failed: ' + msg, 'error');
                                    return;
                                }
                                if (res2 && res2.success) {
                                    showMessage('autosell-message', 'Active set and autosell now following ' + currentBotCoin, 'success');
                                    // refresh status and UI
                                    updateDashboard();
                                    selectBotCoin(currentBotCoin);
                                } else {
                                    showMessage('autosell-message', (res2 && (res2.error || res2.message)) || 'Autosell start failed', 'error');
                                }
                            }).catch(e => showMessage('autosell-message', 'Network error starting autosell', 'error'));
                    });
                } else {
                    showMessage('autosell-message', (res && res.error) || 'Failed to set active coin', 'error');
                }
            }).catch(e => showMessage('autosell-message', 'Network error', 'error'));
    }
        fetch('/api/trades').then(r => r.json()).then(data => {
            const trades = data.trades || [];
            const tbody = document.getElementById('trades-body');
            if (!trades.length) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999; padding: 20px;">No trades</td></tr>';
            } else {
                tbody.innerHTML = trades.slice(0, 10).map(t => `<tr onclick="showTradeDetails(${JSON.stringify(t).replace(/"/g, '&quot;')})"><td>${new Date(t.timestamp * 1000).toLocaleString()}</td><td class="action-${t.action.toLowerCase()}">${t.action}</td><td>${t.price.toFixed(2)}</td><td>${t.volume.toFixed(4)}</td></tr>`).join('');
            }
        }).catch(e => console.error('Trades:', e));
    }

    function loadMonitoringTrades() {
        fetch('/api/status').then(r => r.json()).then(s => {
            const div = document.getElementById('active-positions');
            if (s.bid && s.volume) {
                div.innerHTML = `<div style="background: #f0f7ff; padding: 16px; border-radius: 6px;"><h3 style="margin: 0 0 12px 0;">${s.pair}</h3><div style="font-size: 13px;"><div>Buy: ${s.buy_price.toFixed(2)}</div><div>Bid: ${s.bid.toFixed(2)}</div><div>Vol: ${s.volume.toFixed(4)}</div></div></div>`;
            }
        });
    }

    function refreshTrendSignals() {
        fetch('/api/strategy').then(r => r.json()).then(data => {
            const signals = data.trend_signals || {};
            let html = '';
            for (const [coin, sig] of Object.entries(signals)) {
                const t = sig.trend || 'NEUTRAL';
                const c = t === 'UPTREND' ? '#4CAF50' : t === 'DOWNTREND' ? '#f44336' : '#FF9800';
                const e = t === 'UPTREND' ? '' : t === 'DOWNTREND' ? '' : '';
                html += `<div class="metric"><span class="metric-label">${coin}</span><span class="metric-value" style="color: ${c};">${e} ${t}</span></div>`;
            }
            document.getElementById('trend-signals').innerHTML = html || '<div style="padding: 20px; text-align: center; color: #999;">No signals</div>';
        }).catch(e => console.error('Trends:', e));
    }

    function loadCompoundStats() {
        fetch('/api/strategy').then(r => r.json()).then(data => {
            const c = data.compound_stats || {};
            document.getElementById('compound-total').textContent = (c.total_profit || 0).toFixed(2);
            document.getElementById('compound-reinvest').textContent = (c.total_reinvested || 0).toFixed(2);
            document.getElementById('compound-savings').textContent = (c.total_savings || 0).toFixed(2);
        }).catch(e => console.error('Compound:', e));
    }

    function loadCoinsData() {
        const coins = ['USDTNGN', 'XBTNGN', 'ETHNGN', 'SOLNGN', 'XRPNGN', 'USDCNGN'];
        document.getElementById('coins-grid').innerHTML = coins.map(c => `<div style="background: #f9f9f9; padding: 12px; border-radius: 6px; border-left: 4px solid #2a5298;"><div style="font-weight: bold; color: var(--accent);">${c}</div><div style="font-size: 12px; color: #666;"> Active</div></div>`).join('');
    }

    function refreshSignalLog() {
        fetch('/api/logs').then(r => r.json()).then(data => {
            const lines = data.logs || [];
            const el = document.getElementById('signal-log-terminal');
            if (!lines.length) {
                el.innerHTML = '<div style="color: #888;">No logs</div>';
            } else {
                el.innerHTML = lines.map(line => {
                    let color = '#e6f2ff';
                    if (line.includes('[BUY]')) color = '#4CAF50';
                    else if (line.includes('[SELL]')) color = '#f44336';
                    else if (line.includes('[ERROR]')) color = '#ff6b6b';
                    return `<div style="color: ${color};">${line}</div>`;
                }).join('');
                el.scrollTop = el.scrollHeight;
            }
        }).catch(e => console.error('Logs:', e));
    }

    function updateLogInterval() {
        if (signalLogIntervalId) clearInterval(signalLogIntervalId);
        const ms = parseInt(document.getElementById('log-refresh-interval').value || 2000);
        if (ms > 0) signalLogIntervalId = setInterval(refreshSignalLog, ms);
    }

    function loadStrategyConfig() {
        fetch('/api/strategy/config').then(r => r.json()).then(data => {
            const cfg = data.config || {};
            document.getElementById('coin-select').value = data.active_coin || 'USDTNGN';
            document.getElementById('buy-drop-pct').value = cfg.buy_drop_pct || 3.0;
            document.getElementById('sell-profit-pct').value = cfg.sell_profit_pct || 10.0;
            document.getElementById('stop-loss-pct').value = cfg.stop_loss_pct || 5.0;
        }).catch(e => console.error('Config:', e));
    }

    function saveStrategyConfig() {
        const data = {
            buy_drop_pct: parseFloat(document.getElementById('buy-drop-pct').value),
            sell_profit_pct: parseFloat(document.getElementById('sell-profit-pct').value),
            stop_loss_pct: parseFloat(document.getElementById('stop-loss-pct').value)
        };
        fetch('/api/strategy/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
            .then(r => r.json())
            .then(res => showMessage('strategy-message', res.success ? ' Saved' : ' Error', res.success ? 'success' : 'error'))
            .catch(e => showMessage('strategy-message', ' Error', 'error'));
    }

    function toggleAutoSell() {
        if (document.getElementById('autosell-status').textContent.includes('RUNNING')) stopAutoSell();
        else startAutoSell();
    }

    function startAutoSell() {
        const target = parseFloat(document.getElementById('autosell-target').value || 2.0);
        const pair = (document.getElementById('autosell-pair-input') && document.getElementById('autosell-pair-input').value) || '';
        fetch('/api/autosell/start', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ target_pct: target, pair: pair }) })
            .then(async r => {
                let res = null;
                try { res = await r.json(); } catch (e) { /* ignore parse errors */ }
                if (!r.ok) {
                    const msg = (res && (res.error || res.message)) || (r.status + ' ' + r.statusText);
                    // If authentication required, guide user to login
                    if (r.status === 401) {
                        showMessage('autosell-message', msg + ' — please login.', 'error');
                        return;
                    }
                    showMessage('autosell-message', msg, 'error');
                    return;
                }
                if (res && res.success) {
                    showMessage('autosell-message', ' Started', 'success');
                    document.getElementById('autosell-toggle').textContent = ' Stop';
                    document.getElementById('autosell-status').textContent = ' RUNNING';
                    document.getElementById('autosell-monitor').style.display = 'block';
                    if (window.autoSellInterval) clearInterval(window.autoSellInterval);
                    window.autoSellInterval = setInterval(updateAutoSellStatus, 3000);
                } else {
                    const msg = (res && (res.error || res.message)) || 'Failed to start auto-sell';
                    showMessage('autosell-message', msg, 'error');
                }
            })
            .catch(e => showMessage('autosell-message', ' Network error', 'error'));
    }

    function stopAutoSell() {
        fetch('/api/autosell/stop', { method: 'POST' })
            .then(async r => {
                let res = null;
                try { res = await r.json(); } catch (e) {}
                if (!r.ok) {
                    const msg = (res && (res.error || res.message)) || (r.status + ' ' + r.statusText);
                    showMessage('autosell-message', msg, 'error');
                    return;
                }
                if (res && res.success) {
                    showMessage('autosell-message', ' Stopped', 'success');
                    document.getElementById('autosell-toggle').textContent = ' Start';
                    document.getElementById('autosell-status').textContent = ' STOPPED';
                    document.getElementById('autosell-monitor').style.display = 'none';
                    if (window.autoSellInterval) clearInterval(window.autoSellInterval);
                } else {
                    showMessage('autosell-message', (res && (res.error || res.message)) || 'Failed to stop', 'error');
                }
            })
            .catch(e => showMessage('autosell-message', ' Network error', 'error'));
    }

    function updateAutoSellStatus() {
        fetch('/api/autosell/status').then(r => r.json()).then(res => {
            if (res.success && res.status) {
                const s = res.status;
                document.getElementById('autosell-pair').textContent = s.pair || '--';
                if (document.getElementById('autosell-pair-input')) document.getElementById('autosell-pair-input').value = s.pair || '';
                const txt = '' + (s.profit_ngn || 0).toFixed(2) + ' (' + (s.profit_pct || 0).toFixed(1) + '%)';
                document.getElementById('autosell-profit').textContent = txt;
                // Update hold button state if held_pairs present
                try {
                    const held = (s.held_pairs || []);
                    const currentPair = (s.pair || '').toUpperCase();
                    const holdBtn = document.getElementById('autosell-hold-btn');
                    if (holdBtn) {
                        if (currentPair && held.includes(currentPair)) {
                            holdBtn.textContent = ' Unhold';
                            holdBtn.style.background = '#FFB74D';
                        } else {
                            holdBtn.textContent = ' Hold';
                            holdBtn.style.background = '#666';
                        }
                    }
                } catch (e) {
                    // ignore
                }
            }
        });
    }

    function toggleHold() {
        const pair = (document.getElementById('autosell-pair-input') && document.getElementById('autosell-pair-input').value) || (document.getElementById('manual-pair') && document.getElementById('manual-pair').value) || '';
        if (!pair) { showMessage('autosell-message', ' No pair selected', 'error'); return; }
        // Determine current hold state from /api/autosell/holds
        fetch('/api/autosell/holds').then(r => r.json()).then(res => {
            if (res.success) {
                const held = (res.held_pairs || []).map(x => x.toUpperCase());
                const isHeld = held.includes(pair.toUpperCase());
                // Toggle
                fetch('/api/autosell/hold', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ pair: pair, hold: !isHeld }) })
                    .then(r => r.json()).then(resp => {
                        if (resp.success) {
                            showMessage('autosell-message', (resp.held ? ' Held' : ' Unheld'), 'success');
                            updateAutoSellStatus();
                        } else {
                            showMessage('autosell-message', ' Error', 'error');
                        }
                    }).catch(e => showMessage('autosell-message', ' Error', 'error'));
            } else {
                showMessage('autosell-message', ' Error fetching holds', 'error');
            }
        }).catch(e => showMessage('autosell-message', ' Error', 'error'));
    }

    function placeManualTrade() {
        const pair = document.getElementById('manual-pair').value.trim();
        const side = document.getElementById('manual-side').value;
        const vol = parseFloat(document.getElementById('manual-amount').value || 0);
        if (!pair || !side || vol <= 0) {
            showMessage('trade-message', ' Invalid', 'error');
            return;
        }
        fetch('/api/trade/place', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ pair, side, volume: vol, dry_run: false }) })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    showMessage('trade-message', ' Placed', 'success');
                    updateDashboard();
                } else {
                    showMessage('trade-message', ' ' + (res.error || 'Failed'), 'error');
                }
            })
            .catch(e => showMessage('trade-message', ' Error', 'error'));
    }

    function resetManualTrade() {
        document.getElementById('manual-pair').value = 'XBTNGN';
        document.getElementById('manual-side').value = 'BUY';
        document.getElementById('manual-amount').value = '';
    }

    function toggleRealtimeChart() {
        realtimeStreamActive = !realtimeStreamActive;
        const btn = document.getElementById('realtimeToggle');
        if (realtimeStreamActive) {
            btn.style.background = '#27ae60';
            btn.textContent = ' ON';
            startRealtimeStream(parseInt(document.getElementById('refreshInterval').value));
        } else {
            btn.style.background = '#e74c3c';
            btn.textContent = ' OFF';
            stopRealtimeStream();
        }
    }

    function startRealtimeStream(ms) {
        if (realtimeStreamInterval) clearInterval(realtimeStreamInterval);
        const canvas = document.getElementById('priceChart');
        if (!priceChart && canvas) {
            priceChart = new Chart(canvas, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Price', data: [], borderColor: '#2a5298', fill: false, tension: 0.3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false } } }
            });
        }
        realtimeStreamInterval = setInterval(() => {
            fetch('/api/ticker?pair=XBTNGN').then(r => r.json()).then(t => {
                if (!priceChart) return;
                const p = parseFloat(t.ask || t.bid || 0);
                if (p) {
                    priceChart.data.datasets[0].data.push(p);
                    priceChart.data.labels.push(new Date().toLocaleTimeString());
                    if (priceChart.data.labels.length > 50) {
                        priceChart.data.labels.shift();
                        priceChart.data.datasets[0].data.shift();
                    }
                    priceChart.update('none');
                }
            }).catch(e => {});
        }, ms);
    }

    function stopRealtimeStream() {
        if (realtimeStreamInterval) {
            clearInterval(realtimeStreamInterval);
            realtimeStreamInterval = null;
        }
    }

    function showTradeDetails(trade) {
        const modal = document.getElementById('trade-modal');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        const isBuy = trade.action.toUpperCase().includes('BUY');
        const color = isBuy ? '#4CAF50' : '#f44336';
        title.textContent = (isBuy ? ' ' : ' ') + trade.action.toUpperCase();
        title.style.color = color;
        body.innerHTML = `<div style="background: #f5f5f5; padding: 12px; border-radius: 6px; margin-bottom: 16px;"><div><div style="color: #999; font-size: 12px;">Pair</div><div style="font-weight: bold; color: #333;">${trade.pair}</div></div><div style="margin-top: 8px;"><div style="color: #999; font-size: 12px;">Price</div><div style="font-weight: bold; color: #333;">${trade.price.toFixed(2)}</div></div><div style="margin-top: 8px;"><div style="color: #999; font-size: 12px;">Volume</div><div style="font-weight: bold; color: #333;">${trade.volume.toFixed(4)}</div></div></div><div style="background: #e3f2fd; padding: 12px; border-radius: 6px;"><div style="color: #1976d2; font-size: 12px;">Total</div><div style="font-weight: bold; color: #1565c0; margin-top: 4px;">${(trade.price * trade.volume).toFixed(2)}</div></div>`;
        modal.classList.add('active');
    }

    function closeTradeModal() {
        document.getElementById('trade-modal').classList.remove('active');
    }

    function showMessage(id, msg, type) {
        const el = document.getElementById(id);
        el.className = 'alert-box alert-' + type;
        el.textContent = msg;
        setTimeout(() => { el.className = 'alert-box'; }, 4000);
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateDashboard();
        loadMonitoringTrades();
        refreshSignalLog();
        pollTradingViewStatus();
        setInterval(() => { updateDashboard(); loadMonitoringTrades(); }, 3000);
        document.getElementById('refreshInterval').addEventListener('input', (e) => {
            document.getElementById('intervalDisplay').textContent = e.target.value + 'ms';
            if (realtimeStreamActive) {
                stopRealtimeStream();
                startRealtimeStream(parseInt(e.target.value));
            }
        });
        document.getElementById('trade-modal').addEventListener('click', (e) => {
            if (e.target.id === 'trade-modal') closeTradeModal();
        });
    });

    // Credentials Management Functions
    function toggleCredentialVisibility() {
        const apiKeyInput = document.getElementById('api-key');
        const apiSecretInput = document.getElementById('api-secret');
        const newType = apiKeyInput.type === 'password' ? 'text' : 'password';
        apiKeyInput.type = newType;
        apiSecretInput.type = newType;
    }

    // Poll TradingView status every 5 seconds and update header badge
    function pollTradingViewStatus() {
        function _poll() {
            fetch('/api/tradingview/status').then(r => r.json()).then(res => {
                const badge = document.getElementById('tv-badge');
                const last = document.getElementById('tv-last');
                if (res.success && res.tradingview) {
                    const tv = res.tradingview;
                    const active = res.active;
                    badge.textContent = 'TV: ' + (tv.signal ? tv.signal.toUpperCase() : 'IDLE');
                    badge.className = 'status-badge ' + (active ? 'live' : '');
                    badge.style.background = active ? '#c8e6c9' : '#fff3e0';
                    badge.style.color = active ? '#1b5e20' : '#e65100';
                    last.textContent = tv.last_seen ? 'Last: ' + new Date(tv.last_seen).toLocaleTimeString() : 'Last: --';
                } else {
                    badge.textContent = 'TV: Unknown';
                    badge.style.background = '#fff3e0';
                    badge.style.color = '#e65100';
                    last.textContent = 'Last: --';
                }
            }).catch(e => {
                // silent
            });
        }
        _poll();
        setInterval(_poll, 5000);
    }

    function saveQuotePriority() {
        const val = document.getElementById('quote-priority').value || '';
        const arr = val.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
        fetch('/api/settings/quote_priority', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ quote_priority: arr }) })
            .then(r => r.json()).then(res => {
                const msgEl = document.getElementById('quote-save-msg');
                if (res.success) {
                    msgEl.textContent = 'Saved';
                    setTimeout(() => { msgEl.textContent = ''; }, 3000);
                } else {
                    msgEl.textContent = 'Error';
                }
            }).catch(e => { document.getElementById('quote-save-msg').textContent = 'Error'; });
    }

    function showCredentialMessage(msg, isSuccess = true) {
        const msgEl = document.getElementById('credential-message');
        msgEl.textContent = msg;
        msgEl.className = isSuccess ? 'alert-box alert-success' : 'alert-box alert-error';
        msgEl.style.display = 'block';
    }

    function validateCredentials() {
        const apiKey = document.getElementById('api-key').value.trim();
        const apiSecret = document.getElementById('api-secret').value.trim();
        const pair = document.getElementById('trading-pair').value;

        if (!apiKey || !apiSecret) {
            showCredentialMessage('❌ Please enter both API Key and Secret', false);
            return;
        }

        showCredentialMessage('⏳ Validating credentials...', true);

        fetch('/api/credentials/validate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ api_key: apiKey, api_secret: apiSecret, pair: pair })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showCredentialMessage('✅ ' + data.message, true);
            } else {
                showCredentialMessage('❌ ' + (data.error || 'Validation failed'), false);
            }
        })
        .catch(e => showCredentialMessage('❌ Error: ' + e.message, false));
    }

    function saveCredentials() {
        const apiKey = document.getElementById('api-key').value.trim();
        const apiSecret = document.getElementById('api-secret').value.trim();
        const pair = document.getElementById('trading-pair').value;

        if (!apiKey || !apiSecret) {
            showCredentialMessage('❌ Please enter both API Key and Secret', false);
            return;
        }

        showCredentialMessage('⏳ Saving credentials...', true);

        fetch('/api/credentials/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ api_key: apiKey, api_secret: apiSecret, pair: pair })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showCredentialMessage('✅ ' + data.message, true);
                // Clear inputs after successful save
                setTimeout(() => {
                    document.getElementById('api-key').value = '';
                    document.getElementById('api-secret').value = '';
                    // Load account balances
                    loadAccountBalances();
                }, 1500);
            } else {
                showCredentialMessage('❌ ' + (data.error || 'Save failed'), false);
            }
        })
        .catch(e => showCredentialMessage('❌ Error: ' + e.message, false));
    }

    function loadAccountBalances() {
        showCredentialMessage('⏳ Loading account data...', true);
        
        fetch('/api/account/balances')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showCredentialMessage('✅ ' + data.message, true);
                    if (data.balances && data.balances.length > 0) {
                        displayAccountBalances(data.balances);
                    } else {
                        displayConnectionInfo(data);
                    }
                } else {
                    showCredentialMessage('❌ ' + (data.error || 'Failed to load account data'), false);
                }
            })
            .catch(e => showCredentialMessage('❌ Error loading account data: ' + e.message, false));
    }

    function displayConnectionInfo(data) {
        let html = '<div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">';
        html += '<h3>✅ Account Connected</h3>';
        html += `<p><strong>Trading Pair:</strong> ${data.pair}</p>`;
        html += `<p><strong>Current Price:</strong> ${data.price}</p>`;
        html += '<p style="color: #666; font-size: 12px; margin-top: 10px;">Your API credentials are working! Once you enable "View Account Balances" permission in your Luno API settings, detailed balance information will appear here.</p>';
        html += '</div>';
        
        const infoDiv = document.getElementById('account-balances') || document.createElement('div');
        infoDiv.id = 'account-balances';
        infoDiv.innerHTML = html;
        
        const credForm = document.getElementById('credential-form');
        if (credForm && !document.getElementById('account-balances')) {
            credForm.parentNode.insertBefore(infoDiv, credForm.nextSibling);
        } else if (document.getElementById('account-balances')) {
            document.getElementById('account-balances').innerHTML = html;
        }
    }

    function displayAccountBalances(balances) {
        let html = '<div style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px;">';
        html += '<h3>💰 Account Balances</h3>';
        
        if (balances.length === 0) {
            html += '<p>No balances found</p>';
        } else {
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<tr style="background: #e0e0e0;"><th style="padding: 8px; text-align: left;">Asset</th><th style="padding: 8px; text-align: right;">Available</th><th style="padding: 8px; text-align: right;">Reserved</th><th style="padding: 8px; text-align: right;">Total</th></tr>';
            
            balances.forEach(b => {
                html += `<tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 8px;">${b.asset}</td>
                    <td style="padding: 8px; text-align: right;">${b.balance.toFixed(8)}</td>
                    <td style="padding: 8px; text-align: right;">${b.reserved.toFixed(8)}</td>
                    <td style="padding: 8px; text-align: right; font-weight: bold;">${b.total.toFixed(8)}</td>
                </tr>`;
            });
            
            html += '</table>';
        }
        
        html += '</div>';
        
        const balancesDiv = document.getElementById('account-balances') || document.createElement('div');
        balancesDiv.id = 'account-balances';
        balancesDiv.innerHTML = html;
        
        // Insert after the credential form
        const credForm = document.getElementById('credential-form');
        if (credForm && !document.getElementById('account-balances')) {
            credForm.parentNode.insertBefore(balancesDiv, credForm.nextSibling);
        } else if (document.getElementById('account-balances')) {
            document.getElementById('account-balances').innerHTML = html;
        }
    }

    function loadCredentials() {
        fetch('/api/credentials/get')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('trading-pair').value = data.pair || 'XBTNGN';
                }
            })
            .catch(e => console.log('Could not load credentials:', e));
    }

    function fetchAccountBalance() {
        const container = document.getElementById('account-balance-container');
        if (!container) return;
        
        container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Loading...</div>';
        
        fetch('/api/account/balances')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    if (data.balances && data.balances.length > 0) {
                        displayDashboardBalances(data.balances);
                    } else {
                        // If no detailed balances, show the ticker info
                        container.innerHTML = `
                            <div style="padding: 12px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid var(--accent);">
                                <div style="margin-bottom: 8px;">
                                    <span style="color: var(--muted); font-size: 12px;">Trading Pair:</span>
                                    <span style="font-weight: bold; color: var(--accent); font-size: 14px; margin-left: 8px;">${data.pair}</span>
                                </div>
                                <div>
                                    <span style="color: var(--muted); font-size: 12px;">Current Price:</span>
                                    <span style="font-weight: bold; color: var(--accent); font-size: 14px; margin-left: 8px;">${data.price}</span>
                                </div>
                                <p style="color: var(--muted); font-size: 12px; margin-top: 12px; margin-bottom: 0;">
                                    ℹ️ Detailed balance view requires "View Account Balances" permission enabled in your Luno API settings.
                                </p>
                            </div>
                        `;
                    }
                } else {
                    container.innerHTML = `<div style="padding: 12px; color: var(--danger);">⚠️ ${data.error || 'Failed to load balances'}</div>`;
                }
            })
            .catch(e => {
                container.innerHTML = `<div style="padding: 12px; color: var(--danger);">❌ Error: ${e.message}</div>`;
            });
    }

    function displayDashboardBalances(balances) {
        const container = document.getElementById('account-balance-container');
        if (!container) return;
        
        // Filter out zero balances for cleaner display
        const nonZero = balances.filter(b => b.balance > 0 || b.reserved > 0 || b.unconfirmed > 0);
        const display = nonZero.length > 0 ? nonZero : balances;
        
        let html = '<div style="max-height: 400px; overflow-y: auto;">';
        html += '<table style="width: 100%; font-size: 12px; border-collapse: collapse;">';
        html += '<thead style="background: linear-gradient(180deg, #f5f5f5, #f0f0f0); border-bottom: 2px solid #ddd; position: sticky; top: 0;">';
        html += '<tr>';
        html += '<th style="padding: 10px; text-align: left; color: var(--muted); font-weight: 600; border-right: 1px solid #e0e0e0;">Asset</th>';
        html += '<th style="padding: 10px; text-align: right; color: var(--muted); font-weight: 600; border-right: 1px solid #e0e0e0;">Balance</th>';
        html += '<th style="padding: 10px; text-align: right; color: var(--muted); font-weight: 600; border-right: 1px solid #e0e0e0;">Reserved</th>';
        html += '<th style="padding: 10px; text-align: right; color: var(--muted); font-weight: 600; border-right: 1px solid #e0e0e0;">Available</th>';
        html += '<th style="padding: 10px; text-align: right; color: var(--muted); font-weight: 600;">Unconfirmed</th>';
        html += '</tr></thead><tbody>';
        
        display.forEach((b, i) => {
            const bgColor = i % 2 === 0 ? '#ffffff' : '#f9f9f9';
            const balance = parseFloat(b.balance || 0).toFixed(8);
            const reserved = parseFloat(b.reserved || 0).toFixed(8);
            const available = parseFloat(b.available || b.balance - b.reserved).toFixed(8);
            const unconfirmed = parseFloat(b.unconfirmed || 0).toFixed(8);
            
            // Determine row background based on whether it has balance
            let rowStyle = `background: ${bgColor}; border-bottom: 1px solid #e0e0e0;`;
            if (available > 0) {
                rowStyle = `background: linear-gradient(to right, ${bgColor}, #e8f5e9); border-bottom: 1px solid #c8e6c9; border-left: 3px solid var(--success);`;
            }
            
            html += `<tr style="${rowStyle}">
                <td style="padding: 10px; font-weight: 600; color: #222; border-right: 1px solid #e0e0e0;">${b.asset || 'N/A'}</td>
                <td style="padding: 10px; text-align: right; color: #666; border-right: 1px solid #e0e0e0;">${balance}</td>
                <td style="padding: 10px; text-align: right; color: #ff9800; border-right: 1px solid #e0e0e0;">${reserved}</td>
                <td style="padding: 10px; text-align: right; font-weight: bold; color: var(--success); border-right: 1px solid #e0e0e0;">${available}</td>
                <td style="padding: 10px; text-align: right; color: #2196f3;">${unconfirmed}</td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        
        // Add a summary footer
        let totalAvailable = 0;
        display.forEach(b => {
            totalAvailable += parseFloat(b.available || b.balance - b.reserved || 0);
        });
        
        html += `<div style="margin-top: 12px; padding: 12px; background: #f0f7ff; border-radius: 6px; border-left: 4px solid var(--accent);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--muted); font-weight: 600;">Total Balances:</span>
                <span style="color: var(--accent); font-weight: bold; font-size: 14px;">${display.length} assets</span>
            </div>
        </div>`;
        
        container.innerHTML = html;
    }

    // Auto-load balances when dashboard first loads
    let balanceRefreshInterval = null;
    function startBalanceAutoRefresh() {
        if (!balanceRefreshInterval) {
            fetchAccountBalance(); // First load immediately
            balanceRefreshInterval = setInterval(fetchAccountBalance, 30000); // Then every 30s
        }
    }

    function stopBalanceAutoRefresh() {
        if (balanceRefreshInterval) {
            clearInterval(balanceRefreshInterval);
            balanceRefreshInterval = null;
        }
    }

    // Load credentials when credentials tab is opened
    document.addEventListener('DOMContentLoaded', () => {
        const origSwitchTab = window.switchTab;
        window.switchTab = function(tabName, buttonEl) {
            if (tabName === 'credentials') loadCredentials();
            if (tabName === 'dashboard') startBalanceAutoRefresh();
            origSwitchTab(tabName, buttonEl);
        };
        // Start balance auto-refresh on page load
        startBalanceAutoRefresh();
    });
</script>
</body>
</html>
